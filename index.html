<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰äººç‚¸é£æœº - å¾®ä¿¡é‚€è¯·ç‰ˆ</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 { 
            color: #4a5568; 
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* ç•Œé¢åˆ‡æ¢ */
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            text-align: center;
        }
        .btn:hover { background: #3182ce; }
        .btn-success { background: #48bb78; }
        .btn-success:hover { background: #38a169; }
        
        /* æˆ¿é—´ç•Œé¢ */
        .room-info {
            background: #e6fffa;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }
        .room-id {
            font-size: 32px;
            font-weight: bold;
            color: #2d3748;
            margin: 10px 0;
        }
        .qr-container {
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            display: inline-block;
        }
        .share-link {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            word-break: break-all;
            border: 2px dashed #cbd5e0;
        }
        
        /* ç©å®¶åˆ—è¡¨ */
        .players-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        .player-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-item.ready {
            background: #f0fff4;
            border-left: 5px solid #48bb78;
        }
        .player-badge {
            padding: 5px 15px;
            background: #4299e1;
            color: white;
            border-radius: 20px;
            font-size: 14px;
        }
        
        /* æ¸¸æˆç•Œé¢ */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 3px;
            margin: 20px 0;
        }
        .grid-cell {
            aspect-ratio: 1;
            background: #edf2f7;
            border: 1px solid #cbd5e0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 3px;
        }
        .grid-cell:hover { background: #e2e8f0; }
        .grid-cell.hit { background: #fc8181; color: white; }
        .grid-cell.miss { background: #90cdf4; color: white; }
        
        /* å¾®ä¿¡åˆ†äº« */
        .wechat-tips {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
        }
        .step {
            margin: 10px 0;
            padding-left: 25px;
            position: relative;
        }
        .step:before {
            content: 'â¡ï¸';
            position: absolute;
            left: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¸»èœå• -->
        <div id="screen-menu" class="screen active">
            <h1>ğŸ® ä¸‰äººç‚¸é£æœº</h1>
            <button class="btn" onclick="showScreen('create')">åˆ›å»ºæˆ¿é—´</button>
            <button class="btn" onclick="showScreen('join')">åŠ å…¥æˆ¿é—´</button>
            <button class="btn" onclick="showScreen('help')">æ¸¸æˆè¯´æ˜</button>
        </div>
        
        <!-- åˆ›å»ºæˆ¿é—´ -->
        <div id="screen-create" class="screen">
            <h1>åˆ›å»ºæˆ¿é—´</h1>
            <input type="text" id="playerName" placeholder="ä½ çš„åå­—" class="btn" style="background: #f7fafc; color: #333;">
            <button class="btn btn-success" onclick="createRoom()">åˆ›å»ºæ¸¸æˆæˆ¿é—´</button>
            <button class="btn" onclick="showScreen('menu')">è¿”å›</button>
        </div>
        
        <!-- åŠ å…¥æˆ¿é—´ -->
        <div id="screen-join" class="screen">
            <h1>åŠ å…¥æˆ¿é—´</h1>
            <input type="text" id="joinName" placeholder="ä½ çš„åå­—" class="btn" style="background: #f7fafc; color: #333;">
            <input type="text" id="roomCode" placeholder="è¾“å…¥6ä½æˆ¿é—´ç " class="btn" style="background: #f7fafc; color: #333;">
            <button class="btn btn-success" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
            <button class="btn" onclick="showScreen('menu')">è¿”å›</button>
        </div>
        
        <!-- æˆ¿é—´ç­‰å¾… -->
        <div id="screen-room" class="screen">
            <div class="room-info">
                <h2>æˆ¿é—´å·</h2>
                <div class="room-id" id="roomIdDisplay">---</div>
                <p>ç­‰å¾…ç©å®¶åŠ å…¥ (1/3)</p>
                
                <div class="qr-container">
                    <canvas id="qrcode"></canvas>
                </div>
                
                <div class="share-link" id="shareLink">é“¾æ¥ç”Ÿæˆä¸­...</div>
                <button class="btn" onclick="copyLink()">ğŸ“‹ å¤åˆ¶é“¾æ¥</button>
                
                <div class="players-list" id="playersList"></div>
                
                <button class="btn btn-success" id="readyBtn" onclick="toggleReady()">å‡†å¤‡</button>
                <button class="btn" onclick="leaveRoom()">ç¦»å¼€æˆ¿é—´</button>
            </div>
            
            <div class="wechat-tips">
                <h3>ğŸ“± å¾®ä¿¡é‚€è¯·å¥½å‹ï¼š</h3>
                <div class="step">1. å¤åˆ¶ä¸Šæ–¹é“¾æ¥</div>
                <div class="step">2. ç²˜è´´åˆ°å¾®ä¿¡å‘é€ç»™å¥½å‹</div>
                <div class="step">3. å¥½å‹ç‚¹å‡»é“¾æ¥è‡ªåŠ¨åŠ å…¥</div>
                <div class="step">4. æ»¡3äººè‡ªåŠ¨å¼€å§‹æ¸¸æˆ</div>
            </div>
        </div>
        
        <!-- æ¸¸æˆç•Œé¢ -->
        <div id="screen-game" class="screen">
            <h2 id="gameStatus">æ¸¸æˆè¿›è¡Œä¸­...</h2>
            <div id="gameBoards"></div>
            <button class="btn" onclick="leaveGame()">é€€å‡ºæ¸¸æˆ</button>
        </div>
        
        <!-- å¸®åŠ© -->
        <div id="screen-help" class="screen">
            <h1>æ¸¸æˆè¯´æ˜</h1>
            <div class="room-info">
                <h3>ğŸ¯ æ¸¸æˆç›®æ ‡</h3>
                <p>å‡»è½å…¶ä»–ç©å®¶çš„æ‰€æœ‰é£æœºï¼Œæˆä¸ºæœ€åå¹¸å­˜è€…</p>
                
                <h3>ğŸ‘¥ æ¸¸æˆè§„åˆ™</h3>
                <p>1. æ¯ä¸ªç©å®¶æœ‰3æ¶é£æœº</p>
                <p>2. é£æœºå æ®5ä¸ªæ ¼å­ï¼ˆæœºå¤´1ä¸ªï¼Œæœºç¿¼æœºå°¾å„2ä¸ªï¼‰</p>
                <p>3. è½®æµæ”»å‡»å…¶ä»–ç©å®¶çš„æ ¼å­</p>
                <p>4. ç‡å…ˆå‡»è½æ‰€æœ‰é£æœºè€…è·èƒœ</p>
                
                <h3>ğŸ“± å¾®ä¿¡é‚€è¯·</h3>
                <p>1. åˆ›å»ºæˆ¿é—´åè·å–é“¾æ¥</p>
                <p>2. åœ¨å¾®ä¿¡ä¸­å‘é€ç»™2ä½å¥½å‹</p>
                <p>3. å¥½å‹ç‚¹å‡»é“¾æ¥è‡ªåŠ¨åŠ å…¥</p>
            </div>
            <button class="btn" onclick="showScreen('menu')">è¿”å›</button>
        </div>
    </div>

    <!-- Socket.io å®¢æˆ·ç«¯ -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        // ==================== æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ====================
        let socket = null;
        let roomId = null;
        let playerNum = null;
        let players = [];
        let isReady = false;
        
        // åˆå§‹åŒ–Socketè¿æ¥
        function initSocket() {
            // è¿æ¥åˆ°æœ¬åœ°æœåŠ¡å™¨
            socket = io('http://localhost:3000');
            
            socket.on('connect', () => {
                console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
            });
            
            socket.on('room-created', (data) => {
                roomId = data.roomId;
                playerNum = data.playerNum;
                players = data.players;
                
                document.getElementById('roomIdDisplay').textContent = roomId;
                document.getElementById('shareLink').textContent = data.roomUrl;
                updatePlayersList();
                
                // æ˜¾ç¤ºäºŒç»´ç 
                if (data.qrCode) {
                    const img = document.createElement('img');
                    img.src = data.qrCode;
                    img.width = 200;
                    document.getElementById('qrcode').innerHTML = '';
                    document.getElementById('qrcode').appendChild(img);
                }
                
                showScreen('room');
            });
            
            socket.on('room-joined', (data) => {
                roomId = data.roomId;
                playerNum = data.playerNum;
                players = data.players;
                
                document.getElementById('roomIdDisplay').textContent = roomId;
                updatePlayersList();
                showScreen('room');
            });
            
            socket.on('player-joined', (data) => {
                players = data.players;
                updatePlayersList();
            });
            
            socket.on('player-ready-changed', (data) => {
                players = data.players;
                updatePlayersList();
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                const btn = document.getElementById('readyBtn');
                const myPlayer = players.find(p => p.playerNum === playerNum);
                if (myPlayer && myPlayer.ready) {
                    btn.textContent = 'å·²å‡†å¤‡';
                    btn.style.background = '#48bb78';
                }
            });
            
            socket.on('game-started', (data) => {
                startGame(data);
            });
            
            socket.on('error', (message) => {
                alert('é”™è¯¯: ' + message);
            });
        }
        
        // åˆ›å»ºæˆ¿é—´
        function createRoom() {
            const playerName = document.getElementById('playerName').value || 'ç©å®¶';
            if (!socket) initSocket();
            
            socket.emit('create-room', {
                playerName: playerName
            });
        }
        
        // åŠ å…¥æˆ¿é—´
        function joinRoom() {
            const playerName = document.getElementById('joinName').value || 'ç©å®¶';
            const roomCode = document.getElementById('roomCode').value.toUpperCase();
            
            if (!roomCode || roomCode.length !== 6) {
                alert('è¯·è¾“å…¥6ä½æˆ¿é—´ç ');
                return;
            }
            
            if (!socket) initSocket();
            
            socket.emit('join-room', {
                roomId: roomCode,
                playerName: playerName
            });
        }
        
        // å‡†å¤‡/å–æ¶ˆå‡†å¤‡
        function toggleReady() {
            if (!socket || !roomId) return;
            
            socket.emit('player-ready', {
                roomId: roomId
            });
        }
        
        // æ›´æ–°ç©å®¶åˆ—è¡¨
        function updatePlayersList() {
            const list = document.getElementById('playersList');
            list.innerHTML = '';
            
            players.forEach(player => {
                const div = document.createElement('div');
                div.className = `player-item ${player.ready ? 'ready' : ''}`;
                div.innerHTML = `
                    <div>
                        <strong>${player.name}</strong>
                        ${player.id === socket.id ? '(ä½ )' : ''}
                    </div>
                    <div class="player-badge">
                        ç©å®¶${player.playerNum}
                        ${player.ready ? ' âœ“' : ' ...'}
                    </div>
                `;
                list.appendChild(div);
            });
            
            // æ›´æ–°ç­‰å¾…ä¿¡æ¯
            const info = document.querySelector('.room-info p');
            if (info) {
                info.textContent = `ç­‰å¾…ç©å®¶åŠ å…¥ (${players.length}/3)`;
            }
        }
        
        // å¤åˆ¶é“¾æ¥
        function copyLink() {
            const link = document.getElementById('shareLink').textContent;
            navigator.clipboard.writeText(link).then(() => {
                alert('é“¾æ¥å·²å¤åˆ¶ï¼\n\nç²˜è´´åˆ°å¾®ä¿¡å‘é€ç»™å¥½å‹å³å¯é‚€è¯·ã€‚');
            });
        }
        
        // å¼€å§‹æ¸¸æˆ
        function startGame(data) {
            showScreen('game');
            initGameBoard(data);
        }
        
        // åˆå§‹åŒ–æ¸¸æˆæ¿
        function initGameBoard(data) {
            const boards = document.getElementById('gameBoards');
            boards.innerHTML = '';
            
            // åˆ›å»º3ä¸ªç©å®¶çš„æ¸¸æˆæ¿
            for (let i = 1; i <= 3; i++) {
                const board = document.createElement('div');
                board.className = 'player-board';
                board.innerHTML = `
                    <h3>ç©å®¶${i} ${i === playerNum ? '(ä½ )' : ''}</h3>
                    <div class="game-grid" id="grid-${i}"></div>
                `;
                boards.appendChild(board);
                
                // åˆ›å»º10x10ç½‘æ ¼
                const grid = document.getElementById(`grid-${i}`);
                for (let row = 1; row <= 10; row++) {
                    for (let col = 1; col <= 10; col++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.dataset.row = row;
                        cell.dataset.col = col;
                        cell.dataset.player = i;
                        
                        if (i !== playerNum) {
                            cell.onclick = () => attackPlayer(i, row, col);
                        }
                        
                        grid.appendChild(cell);
                    }
                }
            }
        }
        
        // æ”»å‡»ç©å®¶
        function attackPlayer(targetPlayer, row, col) {
            if (!socket || !roomId) return;
            
            socket.emit('attack', {
                roomId: roomId,
                targetPlayer: targetPlayer,
                row: row,
                col: col,
                playerNum: playerNum
            });
        }
        
        // ç•Œé¢åˆ‡æ¢
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(`screen-${screenName}`).classList.add('active');
        }
        
        // ç¦»å¼€æˆ¿é—´
        function leaveRoom() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            roomId = null;
            playerNum = null;
            players = [];
            showScreen('menu');
        }
        
        // ç¦»å¼€æ¸¸æˆ
        function leaveGame() {
            leaveRoom();
        }
        
        // é¡µé¢åŠ è½½
        window.addEventListener('DOMContentLoaded', () => {
            // æ£€æŸ¥URLä¸­æ˜¯å¦æœ‰æˆ¿é—´å·
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            
            if (roomParam) {
                document.getElementById('roomCode').value = roomParam;
                showScreen('join');
            }
        });
    </script>
</body>
</html>